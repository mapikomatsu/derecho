<script>
  const creditosTotales = 228;
  const estadoCursos = {};

  fetch("cursos_derecho_up.json")
    .then(response => response.json())
    .then(data => {
      const cursos = data.cursos;
      const cursos_clave = data.cursos_clave;

      function puedeActivarse(curso) {
        return curso.prerrequisitos.every(pr => estadoCursos[pr]);
      }

      function renderCiclos() {
        const contenedor = document.getElementById("ciclos");
        contenedor.innerHTML = "";
        const cursosPorCiclo = {};

        cursos.forEach(c => {
          if (!cursosPorCiclo[c.ciclo]) cursosPorCiclo[c.ciclo] = [];
          cursosPorCiclo[c.ciclo].push(c);
        });

        Object.keys(cursosPorCiclo).sort((a, b) => a - b).forEach(ciclo => {
          const div = document.createElement("div");
          div.className = "ciclo";
          const h2 = document.createElement("h2");
          h2.textContent = `Ciclo ${ciclo}`;
          div.appendChild(h2);

          cursosPorCiclo[ciclo].forEach(curso => {
            const divCurso = document.createElement("div");
            divCurso.className = "curso";

            const completado = estadoCursos[curso.nombre];
            const clave = cursos_clave.some(c => c.nombre === curso.nombre);

            if (completado) divCurso.classList.add("completado");
            else if (clave || puedeActivarse(curso)) divCurso.classList.add("activo");
            else divCurso.classList.add("bloqueado");

            divCurso.textContent = curso.nombre;

            const credit = document.createElement("span");
            credit.className = "creditos";
            credit.textContent = `${curso.creditos} créditos`;
            divCurso.appendChild(credit);

            divCurso.onclick = () => {
              estadoCursos[curso.nombre] = !estadoCursos[curso.nombre];
              renderCiclos();
              actualizarCreditos();
            };

            div.appendChild(divCurso);
          });

          contenedor.appendChild(div);
        });
      }

      function actualizarCreditos() {
        let suma = 0;
        cursos.forEach(c => {
          if (estadoCursos[c.nombre]) suma += c.creditos;
        });
        document.getElementById("calculadora").textContent =
          `Has completado ${suma} de ${creditosTotales} créditos`;
      }

      renderCiclos();
    });
</script>
